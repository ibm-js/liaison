<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="../css/examples.css">
		<style type="text/css">
			.close-button {
				color: red;
			}

			ul.namelist {
				margin: 0;
				padding: 2px;
				border: solid #4080ff 1px;
				list-style-type: none;
			}

			ul.namelist liaison-example-collection-item {
				display: inline-block;
				border: solid #4080ff 1px;
				margin: 2px;
				padding: 2px;
			}

			ul.namelist img {
				padding: 1px;
			}
		</style>
		<script type="text/javascript" src="../../../requirejs/require.js" data-main="../../../"></script>
		<script id="collection-item-template" type="text/x-template">
			<li>
				{{item.Name}}
				<span class="close-button" onclick="ctrl.removeItem({{item.id}});">X</span>
			</li>
		</script>
		<script id="collection-template" type="text/x-template">
			<div>
				<form onsubmit="ctrl.addItem(event);">
					<input type="text" placeholder="Type the new name" value="{{newName}}">
				</form>
				<ul class="namelist">
					<template repeat="{{items}}">
						<liaison-example-collection-item item="{{}}"></liaison-example-collection-item>
					</template>
				</ul>
				<div>Sum of lengths of names: {{totalNameLength}}</div>
			</div>
		</script>
		<script type="text/javascript">
			var ctrl;
			require([
				"dcl/dcl",
				"delite/register",
				"delite/Widget",
				"liaison/wrapper",
				"liaison/ObservablePath",
				"liaison/BindingSourceList",
				"liaison/Each",
				"liaison/delite/createRenderer",
				"liaison/delite/TemplateBinderExtension"
			], function(dcl, register, Widget, wrapper, ObservablePath, BindingSourceList, Each, createRenderer){
				function startup(){
					var seq = 0;
					register("liaison-example-collection-item", [HTMLLIElement, Widget], {
						buildRendering: createRenderer(document.getElementById("collection-item-template").innerHTML),
						baseClass: "liaison-example-collection-item",
						item: undefined
					});
					register("liaison-example-collection", [HTMLElement, Widget], {
						buildRendering: createRenderer(document.getElementById("collection-template").innerHTML),
						baseClass: "liaison-example-collection",
						addItem: function(event){
							this.items.push({id: seq++, Name: this.newName});
							this.set("newName", "");
							event.preventDefault();
						},
						removeItem: function(id){
							var index = this.items.indexOf(this.items.filter(function(entry){ return entry.id == id; })[0]);
							if(index >= 0){
								this.items.splice(index, 1);
							}
						},
						items: wrapper.wrap([
							{id: seq++, Name: "Anne Ackerman"},
							{id: seq++, Name: "Ben Beckham"},
							{id: seq++, Name: "Chad Chapman"},
							{id: seq++, Name: "Irene Ira"},
							{id: seq++, Name: "John Jacklin"}
						]),
						createdCallback: dcl.superCall(function(sup){
							return function(){
								this.totalNameLength = new Each(new ObservablePath(this, "items"), function(a){
									return a.reduce(function(length, entry){
										return length + entry.Name.length;
									}, 0);
								});
								sup && sup.apply(this, arguments);
							};
						})
					});
					register.parse();
					ctrl = document.querySelector("liaison-example-collection"); // TODO(asudoh): Can we use data-dojo-attach-event?
				}
				document.body ? startup() : window.addEventListener("DOMContentLoaded", startup);
			});
		</script>
	</head>
	<body>
		<liaison-example-collection></liaison-example-collection>
	</body>
</html>
